{"version":3,"sources":["../../../../src/core/sprites/canvas/CanvasSpriteRenderer.js"],"names":["canvasRenderWorldTransform","CanvasSpriteRenderer","renderer","render","sprite","texture","_texture","width","_frame","height","wt","transform","worldTransform","dx","dy","orig","baseTexture","source","setBlendMode","blendMode","valid","context","globalAlpha","worldAlpha","smoothingEnabled","scaleMode","LINEAR","smoothProperty","trim","x","anchor","y","rotate","copy","matrixAppendRotationInv","roundPixels","setTransform","a","b","c","d","tx","resolution","ty","tint","cachedTint","tintedTexture","getTintedTexture","drawImage","destroy","registerPlugin"],"mappings":"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","file":"CanvasSpriteRenderer.js","sourcesContent":["import CanvasRenderer from '../../renderers/canvas/CanvasRenderer';\nimport { SCALE_MODES } from '../../const';\nimport { Matrix, GroupD8 } from '../../math';\nimport CanvasTinter from './CanvasTinter';\n\nconst canvasRenderWorldTransform = new Matrix();\n\n/**\n * @author Mat Groves\n *\n * Big thanks to the very clever Matt DesLauriers <mattdesl> https://github.com/mattdesl/\n * for creating the original pixi version!\n * Also a thanks to https://github.com/bchevalier for tweaking the tint and alpha so that they now\n * share 4 bytes on the vertex buffer\n *\n * Heavily inspired by LibGDX's CanvasSpriteRenderer:\n * https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g2d/CanvasSpriteRenderer.java\n */\n\n/**\n * Renderer dedicated to drawing and batching sprites.\n *\n * @class\n * @private\n * @memberof PIXI\n */\nexport default class CanvasSpriteRenderer\n{\n    /**\n     * @param {PIXI.WebGLRenderer} renderer -The renderer sprite this batch works for.\n     */\n    constructor(renderer)\n    {\n        this.renderer = renderer;\n    }\n\n    /**\n     * Renders the sprite object.\n     *\n     * @param {PIXI.Sprite} sprite - the sprite to render when using this spritebatch\n     */\n    render(sprite)\n    {\n        const texture = sprite._texture;\n        const renderer = this.renderer;\n\n        const width = texture._frame.width;\n        const height = texture._frame.height;\n\n        let wt = sprite.transform.worldTransform;\n        let dx = 0;\n        let dy = 0;\n\n        if (texture.orig.width <= 0 || texture.orig.height <= 0 || !texture.baseTexture.source)\n        {\n            return;\n        }\n\n        renderer.setBlendMode(sprite.blendMode);\n\n        //  Ignore null sources\n        if (texture.valid)\n        {\n            renderer.context.globalAlpha = sprite.worldAlpha;\n\n            // If smoothingEnabled is supported and we need to change the smoothing property for sprite texture\n            const smoothingEnabled = texture.baseTexture.scaleMode === SCALE_MODES.LINEAR;\n\n            if (renderer.smoothProperty && renderer.context[renderer.smoothProperty] !== smoothingEnabled)\n            {\n                renderer.context[renderer.smoothProperty] = smoothingEnabled;\n            }\n\n            if (texture.trim)\n            {\n                dx = (texture.trim.width / 2) + texture.trim.x - (sprite.anchor.x * texture.orig.width);\n                dy = (texture.trim.height / 2) + texture.trim.y - (sprite.anchor.y * texture.orig.height);\n            }\n            else\n            {\n                dx = (0.5 - sprite.anchor.x) * texture.orig.width;\n                dy = (0.5 - sprite.anchor.y) * texture.orig.height;\n            }\n\n            if (texture.rotate)\n            {\n                wt.copy(canvasRenderWorldTransform);\n                wt = canvasRenderWorldTransform;\n                GroupD8.matrixAppendRotationInv(wt, texture.rotate, dx, dy);\n                // the anchor has already been applied above, so lets set it to zero\n                dx = 0;\n                dy = 0;\n            }\n\n            dx -= width / 2;\n            dy -= height / 2;\n\n            // Allow for pixel rounding\n            if (renderer.roundPixels)\n            {\n                renderer.context.setTransform(\n                    wt.a,\n                    wt.b,\n                    wt.c,\n                    wt.d,\n                    (wt.tx * renderer.resolution) | 0,\n                    (wt.ty * renderer.resolution) | 0\n                );\n\n                dx = dx | 0;\n                dy = dy | 0;\n            }\n            else\n            {\n                renderer.context.setTransform(\n                    wt.a,\n                    wt.b,\n                    wt.c,\n                    wt.d,\n                    wt.tx * renderer.resolution,\n                    wt.ty * renderer.resolution\n                );\n            }\n\n            const resolution = texture.baseTexture.resolution;\n\n            if (sprite.tint !== 0xFFFFFF)\n            {\n                if (sprite.cachedTint !== sprite.tint)\n                {\n                    sprite.cachedTint = sprite.tint;\n\n                    // TODO clean up caching - how to clean up the caches?\n                    sprite.tintedTexture = CanvasTinter.getTintedTexture(sprite, sprite.tint);\n                }\n\n                renderer.context.drawImage(\n                    sprite.tintedTexture,\n                    0,\n                    0,\n                    width * resolution,\n                    height * resolution,\n                    dx * renderer.resolution,\n                    dy * renderer.resolution,\n                    width * renderer.resolution,\n                    height * renderer.resolution\n                );\n            }\n            else\n            {\n                renderer.context.drawImage(\n                    texture.baseTexture.source,\n                    texture._frame.x * resolution,\n                    texture._frame.y * resolution,\n                    width * resolution,\n                    height * resolution,\n                    dx * renderer.resolution,\n                    dy * renderer.resolution,\n                    width * renderer.resolution,\n                    height * renderer.resolution\n                );\n            }\n        }\n    }\n\n    /**\n     * destroy the sprite object.\n     *\n     */\n    destroy()\n    {\n        this.renderer = null;\n    }\n}\n\nCanvasRenderer.registerPlugin('sprite', CanvasSpriteRenderer);\n"]}